<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Karl Playground</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        #toolbar {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #container {
            flex: 1;
            display: flex;
        }

        #editor {
            flex: 1;
            padding: 15px;
            font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", "Source Code Pro", monospace;
            font-size: 14px;
            border: none;
            resize: none;
            outline: none;
            background: #fff;
            line-height: 1.5;
            color: #24292e;
        }

        #output {
            flex: 1;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", "Droid Sans Mono", "Source Code Pro", monospace;
            font-size: 14px;
            overflow: auto;
            white-space: pre-wrap;
            border-left: 1px solid #ddd;
            margin: 0;
            line-height: 1.5;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: #1557b0;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            font-size: 0.9em;
            color: #666;
        }

        .title {
            font-weight: bold;
            font-size: 18px;
            color: #202124;
            margin-right: 10px;
        }
    </style>
    <script src="wasm_exec.js"></script>
</head>

<body>
    <div id="toolbar">
        <div class="title">Karl Playground</div>
        <button id="runBtn" disabled>Run â–¶</button>
        <label style="margin-left: 10px; font-size: 14px; user-select: none;">
            <input type="checkbox" id="autoRun"> Auto Run
        </label>
        <span id="status" style="margin-left: 15px;">Loading WASM environment...</span>
    </div>
    <div id="container">
        <textarea id="editor" spellcheck="false" placeholder="Write your Karl code here...">// Welcome to Karl Playground
// Karl is a functional-first language.

// Define a function
let add = (a, b) -> a + b

// Use list operations
let nums = [1, 2, 3, 4, 5]
let squares = nums.map((x) -> x * x)

log("Squares:", squares)
sleep(2000) // Sleep for 2 seconds (non-blocking in worker)
log("Sum of squares:", squares.reduce(add, 0))

// Example of concurrency
// let c = channel()
// spawn (ch) -> {
//     ch.send("Hello from thread!")
// }(c)
// log(c.recv())
</textarea>
        <pre id="output"></pre>
    </div>
    <script>
        const runBtn = document.getElementById('runBtn');
        const autoRunCheckbox = document.getElementById('autoRun');
        const status = document.getElementById('status');
        const editor = document.getElementById('editor');
        const output = document.getElementById('output');

        let worker;

        function initWorker() {
            if (worker) worker.terminate();

            worker = new Worker("worker.js");

            worker.onmessage = (e) => {
                const msg = e.data;
                if (msg.type === 'ready') {
                    runBtn.disabled = false;
                    status.textContent = "Ready";
                } else if (msg.type === 'output') {
                    output.textContent += msg.data;
                    output.scrollTop = output.scrollHeight;
                } else if (msg.type === 'error') {
                    console.error("Worker error:", msg.data);
                    status.textContent = "Error: " + msg.data;
                    status.style.color = "red";
                } else if (msg.type === 'done') {
                    status.textContent = "Ready";
                    runBtn.disabled = false;
                }
            };

            // Send init message
            worker.postMessage({ type: 'init' });
        }

        initWorker();

        // Run function
        const runCode = () => {
            output.textContent = "";

            if (worker) {
                status.textContent = "Running...";
                runBtn.disabled = true; // Prevent double click
                worker.postMessage({ type: 'run', source: editor.value });
            } else {
                output.textContent = "Error: Worker not initialized";
            }
        };

        runBtn.addEventListener('click', runCode);

        editor.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                runCode();
            }
        });

        // Auto-run Logic
        let debounceTimer;
        editor.addEventListener('input', () => {
            if (autoRunCheckbox.checked) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    runCode();
                }, 800); // 800ms delay
            }
        });
    </script>
</body>

</html>